doctype html

html#hELLO(
  x-data='app'
  lang='ko'
  class='scroll-smooth h-full overflow-hidden')
  head
    meta(charset='utf-8')
    meta(name='viewport' content='width=device-width')

    title [##_page_title_##] — [##_title_##]

    link(rel='alternate' type='application/rss+xml' title='[##_title_##]' href='[##_rss_url_##]')

    link(rel='preconnect' href='//fonts.googleapis.com')
    link(rel='preconnect' href='//fonts.gstatic.com' crossorigin)

    link(rel='stylesheet' :href='"//cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css"')
    link(rel='stylesheet' :href='"//cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"')
    link(rel='stylesheet' :href='"//cdn.jsdelivr.net/gh/wan2land/d2coding/d2coding-ligature-full.css"')
    link(rel='stylesheet' :href='"//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"')
    
    //- highlight.js CDN
    link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js')
    
    script(src='./images/bootstrap.js')

    style(fixed).
      :root {
        --h-idx: 1100px; /* index */
        --h-pem: [##_var_width_##]px; /* permalink */
        --h-s: 256px; /* sidebar */
        --h-c: calc(100% - var(--h-s)); /* content */
        --h-h: 256px; /* header */
        
        /* 라이트 모드 색상 */
        --color-text-primary: #1a1a1a;
        --color-text-secondary: #4a4a4a;
        --color-text-tertiary: #6b7280;
        --color-bg-primary: #ffffff;
        --color-bg-secondary: #f9fafb;
        --color-bg-tertiary: #f3f4f6;
        --color-border: #e5e7eb;
        --color-link: #3b82f6;
        --color-link-hover: #2563eb;
      }
      
      .dark {
        /* 다크 모드 색상 */
        --color-text-primary: #f9fafb;
        --color-text-secondary: #d1d5db;
        --color-text-tertiary: #9ca3af;
        --color-bg-primary: #111827;
        --color-bg-secondary: #1f2937;
        --color-bg-tertiary: #374151;
        --color-border: #374151;
        --color-link: #60a5fa;
        --color-link-hover: #93c5fd;
      }
      
      /* 시스템 기본 색상 적용 */
      body {
        color: var(--color-text-primary);
        background-color: var(--color-bg-primary);
        transition: color 0.2s ease, background-color 0.2s ease;
      }
      
      /* 링크 색상 */
      a {
        color: var(--color-link);
        transition: color 0.2s ease;
      }
      
      a:hover {
        color: var(--color-link-hover);
      }
      
      /* 보조 텍스트 */
      .text-secondary {
        color: var(--color-text-secondary);
      }
      
      .text-tertiary {
        color: var(--color-text-tertiary);
      }
      
      /* 배경색 */
      .bg-secondary {
        background-color: var(--color-bg-secondary);
      }
      
      .bg-tertiary {
        background-color: var(--color-bg-tertiary);
      }

    style
      include:postcss @/css/app.css
      include:postcss @/css/shortcutLayer.css

    script(fixed).
      /**
       * Set skin options
       *
       * @see https://tistory.github.io/document-tistory-skin/common/variable.html
       * @see docs/index.xml
       */
      window.skinOptions = {
        sidebar: '[##_var_sidebar_##]',
        foldableCategory: '[##_var_foldable-category_##]',
        width: '[##_var_width_##]',
        toc: '[##_var_toc_##]',
        scrollspy: '[##_var_scrollspy_##]',
        hljs: '[##_var_hljs_##]',
        hljsDark: '[##_var_hljs-dark_##]',
        headerStyle: '[##_var_header-style_##]'
      }

  body(
    id='[##_body_id_##]'
    class='overflow-x-hidden bg-h-100 dark:bg-h-800 h-full')
    block TIDORY

    script.
      // Alpine Store 정의 (전역 상태 관리)
      document.addEventListener('alpine:init', () => {
        Alpine.store('app', {
          dark: darkMode.on,
          loading: true
        });
        
        // Bottom 컴포넌트 (다크모드 토글)
        Alpine.data('bottom', () => ({
          toggleTheme () {
            darkMode.toggle()
            if (Alpine.store('app')) {
              Alpine.store('app').dark = !Alpine.store('app').dark
            }
          }
        }));
        
        // 소셜 링크 파싱 컴포넌트
        Alpine.data('parseSocialLinks', (description = '') => ({
          description,
          socialLinks: [],
          
          init() {
            const desc = this.description || '';
            const links = [];
            
            // GitHub
            const github = desc.match(/github\.com\/([a-zA-Z0-9_-]+)/i);
            if (github) links.push({ url: `https://github.com/${github[1]}`, icon: 'fa-brands fa-github' });
            
            // LinkedIn
            const linkedin = desc.match(/linkedin\.com\/in\/([a-zA-Z0-9_-]+)/i);
            if (linkedin) links.push({ url: `https://linkedin.com/in/${linkedin[1]}`, icon: 'fa-brands fa-linkedin' });
            
            // Instagram
            const instagram = desc.match(/instagram\.com\/([a-zA-Z0-9_.]+)/i);
            if (instagram) links.push({ url: `https://instagram.com/${instagram[1]}`, icon: 'fa-brands fa-instagram' });
            
            // Twitter/X
            const twitter = desc.match(/(?:twitter\.com|x\.com)\/([a-zA-Z0-9_]+)/i);
            if (twitter) links.push({ url: `https://x.com/${twitter[1]}`, icon: 'fa-brands fa-x-twitter' });
            
            // Email
            const email = desc.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            if (email) links.push({ url: `mailto:${email[1]}`, icon: 'fa-solid fa-envelope' });
            
            this.socialLinks = links;
          }
        }));
        
        // Tag 컴포넌트 (태그 쉼표 제거)
        Alpine.data('tag', () => ({
          init () {
            this.removeAllCommas()
          },
          removeAllCommas () {
            for (const node of this.$el.childNodes) {
              if (node.nodeType === 3) {
                node.remove()
              }
            }
          }
        }));

        // 링크 아이콘 라우터 (이름 기반 아이콘 매핑)
        Alpine.data('linkIconRouter', () => ({
          iconClass: 'fa-solid fa-link',
          iconStyle: '',
          
          init() {
            // 부모 a 태그의 title (링크 이름) 찾기
            const name = this.$el.closest('a').getAttribute('title') || '';
            const result = this.getIcon(name);
            this.iconClass = result.className;
            this.iconStyle = result.style || '';
          },
          
          getIcon(name) {
            const n = name.toLowerCase();
            
            // Custom Font Awesome Icons
            if (n.includes('밀로(millo)') || n.includes('밀로')) {
              return { className: 'fa-solid fa-lightbulb' };  // 사이드 프로젝트 (아이디어/혁신)
            }
            if (n.includes('project') || n.includes('프로젝트')) {
              return { className: 'fa-solid fa-code-branch' };  // 프로젝트 저장소 (Git 브랜치)
            }

            // Font Awesome Icons
            if (n.includes('github')) return { className: 'fa-brands fa-github' };
            if (n.includes('gitlab')) return { className: 'fa-brands fa-gitlab' };
            if (n.includes('linkedin')) return { className: 'fa-brands fa-linkedin' };
            if (n.includes('instagram')) return { className: 'fa-brands fa-instagram' };
            if (n.includes('twitter') || n === 'x') return { className: 'fa-brands fa-x-twitter' };
            if (n.includes('facebook')) return { className: 'fa-brands fa-facebook' };
            if (n.includes('youtube')) return { className: 'fa-brands fa-youtube' };
            if (n.includes('twitch')) return { className: 'fa-brands fa-twitch' };
            if (n.includes('tiktok')) return { className: 'fa-brands fa-tiktok' };
            if (n.includes('discord')) return { className: 'fa-brands fa-discord' };
            if (n.includes('email') || n.includes('mail') || n.includes('메일')) return { className: 'fa-solid fa-envelope' };
            if (n.includes('velog')) return { className: 'fa-brands fa-vimeo-v' };
            if (n.includes('notion')) return { className: 'fa-solid fa-n' };
            
            return { className: 'fa-solid fa-link' };
          }
        }));
      });

    script.
      document.addEventListener('alpine:init', () => Alpine.data('app', () => ({
        /**
         * @type {boolean}
         */
        get dark() {
          return Alpine.store('app').dark;
        },

        /**
         * @type {boolean}
         */
        get loading() {
          return Alpine.store('app').loading;
        },

        /**
         * Init
         */
        init () {
          this.loaded()
        },

        /**
         * Loaded
         */
        loaded () {
          setTimeout(() => Alpine.store('app').loading = false, 100)
        }
      })))

    script.
      ;(function() {
        function initAdminButton() {
          // 1. 글 상세 페이지면 Fallback 버튼 링크 수정
          if (typeof T !== 'undefined' && T.config && T.config.entryId) {
            var btn = document.getElementById('admin-edit-fallback');
            if (btn) {
              btn.href = '/manage/newpost/?id=' + T.config.entryId + '&type=post';
              btn.title = '수정';
            }
          }
          
          // 2. 티스토리 네이티브 관리 버튼(.wrap_btn_etc) 감지 및 이동
          // MutationObserver로 비동기 로드 대응
          if (typeof MutationObserver !== 'undefined') {
            var observer = new MutationObserver(function(mutations, obs) {
              var nativeBtn = document.querySelector('.wrap_btn_etc');
              var bottomWrap = document.querySelector('#bottom .wrap');
              var fallbackBtn = document.getElementById('admin-edit-fallback');
              
              if (nativeBtn && bottomWrap) {
                // 이미 이동된 상태인지 확인 (무한 루프 방지)
                if (bottomWrap.contains(nativeBtn)) {
                  return;
                }
                
                // Fallback 숨김
                if (fallbackBtn) fallbackBtn.style.display = 'none';
                
                // 스타일 초기화 및 표시 설정 (중요: !important로 강제 노출)
                nativeBtn.style.cssText = 'display: flex !important; align-items: center; justify-content: center; position: static; margin: 0;';
                
                // 아이콘 등 내부 스타일 조정이 필요할 수 있음
                // nativeBtn 내부 button에도 스타일 적용
                var innerBtn = nativeBtn.querySelector('button');
                if (innerBtn) {
                  innerBtn.style.cssText = 'width: 100%; height: 100%; padding: 0; border: none; background: none; display: flex; align-items: center; justify-content: center;';
                }

                // 플로팅 바로 이동 (테마 버튼 앞으로)
                bottomWrap.insertBefore(nativeBtn, bottomWrap.firstChild);
                
                // 이동 후에는 감시 중단
                obs.disconnect();
              }
            });
            
            observer.observe(document.body, {
              childList: true,
              subtree: true
            });
          }
          
          // 초기 로드 시에도 한 번 실행
          setTimeout(function() {
             var nativeBtn = document.querySelector('.wrap_btn_etc');
             var bottomWrap = document.querySelector('#bottom .wrap');
             if (nativeBtn && bottomWrap && !bottomWrap.contains(nativeBtn)) {
               var fallbackBtn = document.getElementById('admin-edit-fallback');
               if (fallbackBtn) fallbackBtn.style.display = 'none';
               nativeBtn.style.cssText = 'display: flex !important; align-items: center; justify-content: center; position: static; margin: 0;';
               bottomWrap.insertBefore(nativeBtn, bottomWrap.firstChild);
             }
          }, 500);
        }

        if (document.readyState === 'loading') {
          window.addEventListener('DOMContentLoaded', initAdminButton);
        } else {
          initAdminButton();
        }
      })();

    script.
      window.addEventListener('DOMContentLoaded', () => Alpine.start())

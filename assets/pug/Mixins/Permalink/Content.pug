//- 전체 컨테이너 (flex 레이아웃: 본문 + TOC)
#content-wrapper(x-data='content' class='xl:flex xl:gap-8 xl:max-w-7xl xl:mx-auto xl:px-4')
  //- 본문 + Footer 컨테이너 (flex-1로 남은 공간 차지)
  #content(class='permalink-container xl:flex-1 xl:min-w-0')
    //- 본문 영역
    .content-main(x-ref='article')
      include Content/Article
    
    s_if_var_scrollspy
      include Content/Scrollspy
    
    //- Footer (본문과 같은 너비)
    include ./Footer

  //- TOC 사이드 (sticky로 스크롤 따라다님)
  s_if_var_toc
    aside.content-toc(x-data='toc')
      include Content/TOC

  //- 게시글 전용 Top 버튼 (우측 하단 fixed)
  button#go-top-btn(
    style="display: none;"
    class='fixed bottom-8 right-8 w-12 h-12 bg-h-blue text-h-100 rounded-full shadow-lg flex items-center justify-center hover:bg-h-blue/80 transition-all z-50 cursor-pointer')
    i.fa-solid.fa-chevron-up

script(once='go-top-btn-script').
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('go-top-btn');
    if (!btn) return;
    
    // .main-content가 스크롤 컨테이너
    const container = document.querySelector('.main-content') || window;
    
    function checkScroll() {
      const scrollY = container === window 
        ? (window.scrollY || document.documentElement.scrollTop)
        : container.scrollTop;
      
      btn.style.display = scrollY > 200 ? 'flex' : 'none';
    }
    
    container.addEventListener('scroll', checkScroll);
    
    btn.addEventListener('click', function() {
      container.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    checkScroll();
  });

style(once='toc-layout-style')
  :postcss
    #content-wrapper {
      @apply w-full relative;
    }
    
    .content-toc {
      @apply hidden;
      
      @media (min-width: 1280px) {
        @apply block w-56 flex-shrink-0;
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        align-self: flex-start;
      }
    }

script(once='alpine-article-component').
  document.addEventListener('alpine:init', () => Alpine.data('content', () => ({
    /**
     * Support Headings
     *
     * @property {array} headings
     */
    supportHeadings: '.contents_style > h2, .contents_style > h3',

    /**
     * Headings
     *
     * @property {array} headings
     */
    headings: [],

    /**
     * TOC 표시 여부 (본문이 화면에 있을 때만 true)
     */
    tocVisible: false,

    /**
     * Init 'content' Component
     */
    init () {
      this.setAnchorToHeadings()
      this.collectHeading()
      this.highlightCodeBlocks()
      this.addBlankHashToMoreLesses()
      this.setPositionToImages()
      this.observeArticle()
    },

    /**
     * IntersectionObserver로 본문 영역 감지
     */
    observeArticle () {
      const article = this.$refs.article
      if (!article) return
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          this.tocVisible = entry.isIntersecting
        })
      }, {
        threshold: 0,
        rootMargin: '-96px 0px 0px 0px'
      })
      
      observer.observe(article)
    },

    /**
     * Add blank hash To morelesses
     */
    addBlankHashToMoreLesses () {
      this.$article.querySelectorAll('a.btn-toggle-moreless').forEach($moreless => {
        $moreless.setAttribute('href', '#')
      })
    },

    /**
     * Syntax highlighting code blocks in template (Shiki CDN)
     */
    highlightCodeBlocks () {
      this.$article.querySelectorAll('pre code').forEach(codeBlock => {
        if (window.highlightWithShiki) {
          window.highlightWithShiki(codeBlock)
        }
      })
    },

    /**
     * Collect heading in template
     */
    collectHeading () {
      this.$headings.forEach($heading => {
        const heading = this.heading($heading)

        this.headings.push(heading)
      })
    },

    /**
     * Get new Scrollspy item
     *
     * @param {HTMLElement} $heading
     *
     * @return {object}
     */
    heading ($heading) {
      return {
        tagName: $heading.tagName,
        id: $heading.id,
        href: `#${$heading.id}`,
        text: $heading.textContent,
        active: false
      }
    },

    /**
     * Set position to images
     */
    setPositionToImages () {
      this.$article.querySelectorAll('figure.imageblock').forEach(this.setImageBlockPosition.bind(this))
      this.$article.querySelectorAll('figure.imagegridblock').forEach(this.setImageGridBlockPosition.bind(this))
    },

    /**
     * Set image block position
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageBlockPosition ($imageBlock) {
      const width = this.imageBlockWidth($imageBlock)

      if ($imageBlock.classList.contains('alignCenter')) {
        this.setImageBlockToCenter($imageBlock)
      }

      if ($imageBlock.classList.contains('widthContent')) {
        return
      }

      this.setImageBlockWidth($imageBlock, width)
    },

    /**
     * Set image grid block position
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageGridBlockPosition ($imageBlock) {
      const width = this.imageGridBlockWidth()

      this.setImageBlockToCenter($imageBlock)
      this.setImageBlockWidth($imageBlock, width)
    },

    /**
     * Center image block
     *
     * @param {HTMLElement} $imageBlock
     */
    imageBlockWidth ($imageBlock) {
      const $imageWrap = $imageBlock.querySelector('span, a')
      const $image = $imageWrap.querySelector('img')
      const width = $image.getAttribute('width') || $imageBlock.dataset.originWidth

      return width > 1100 ? 1100 : width
    },

    /**
     * Center image grid block
     */
    imageGridBlockWidth () {
      return 1100
    },

    /**
     * set Image Width
     *
     * @param {HTMLElement} $imageBlock
     * @param {String|Number} width
     */
    setImageBlockWidth ($imageBlock, width) {
      $imageBlock.style.width = `${width}px`
      $imageBlock.style.maxWidth = `${width}px`
    },

    /**
     * set Image block to center
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageBlockToCenter ($imageBlock) {
      $imageBlock.style.marginLeft = '50%'
      $imageBlock.style.transform = 'translateX(-50%)'
    },

    /**
     * Set anchor to headings in template
     */
    setAnchorToHeadings () {
      this.$headings.forEach(this.setAnchorToHeading.bind(this))
    },

    /**
     * Set anchor to heading
     *
     * @param {HTMLElement} $heading
     * @param {number} index
     */
    setAnchorToHeading ($heading, index) {
      const link = this.link($heading, index)
      const $anchor = this.$anchor($heading, `#${link}`)

      $heading.setAttribute('id', link)
      $heading.innerHTML = $anchor.outerHTML
    },

    /**
     * Get link for heading
     *
     * @param {HTMLElement} $heading
     * @param {number} index
     *
     * @return {string}
     */
    link ($heading, index) {
      return this.$id(encodeURIComponent($heading.textContent), index)
    },

    /**
     * Get new anchor
     *
     * @param {HTMLElement} $heading
     * @param {string} link
     *
     * @return {HTMLElement}
     */
    $anchor ($heading, link) {
      const $anchor = document.createElement('a')

      $anchor.setAttribute('href', link)
      $anchor.innerHTML = $heading.innerHTML

      return $anchor
    },

    /**
     * Get article template content
     *
     * @return {HTMLElement}
     */
    get $article () {
      return this.$refs.article
    },

    /**
     * Get headings in content
     *
     * @return {NodeListOf<HTMLElement>}
     */
    get $headings () {
      return this.$article.querySelectorAll(this.supportHeadings)
    }
  })))

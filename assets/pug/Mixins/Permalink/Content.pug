//- 전체 컨테이너 (본문 + TOC flex 레이아웃)
#content(
  x-data='content'
  class='permalink-container')
  //- flex 컨테이너 (본문 + TOC)
  .content-flex(class='xl:flex xl:gap-16')
    //- 본문 영역 (720px 고정)
    .content-main(x-ref='article' class='w-[720px] max-w-full xl:max-w-[720px]')
      include Content/Article
    
    //- TOC 사이드 (xl에서만 표시, sticky)
    s_if_var_toc
      aside.content-toc(
        x-show='tocVisible'
        x-transition:enter='transition ease-out duration-200'
        x-transition:enter-start='opacity-0'
        x-transition:enter-end='opacity-100'
        x-transition:leave='transition ease-in duration-150'
        x-transition:leave-start='opacity-100'
        x-transition:leave-end='opacity-0')
        .toc-sticky(class='sticky top-24')
          include Content/TOC
  
  s_if_var_scrollspy
    include Content/Scrollspy
  
  //- 게시글 전용 Top 버튼 (우측 하단 fixed)
  button.go-top-btn(
    x-show='tocVisible'
    x-transition
    @click="(document.querySelector('.main-content') || window).scrollTo({ top: 0, behavior: 'smooth' })"
    class='fixed bottom-8 right-20 w-12 h-12 bg-h-blue text-h-100 rounded-full shadow-lg flex items-center justify-center hover:bg-h-blue/80 transition-colors z-50')
    i.fa-solid.fa-chevron-up

style(once='toc-layout-style')
  :postcss
    .content-toc {
      @apply hidden;
      
      @media (min-width: 1280px) {
        @apply block w-56 flex-shrink-0;
      }
    }
    
    .go-top-btn {
      @apply hidden;
      
      @media (min-width: 768px) {
        @apply flex;
      }
    }
script(once='alpine-article-component').
  document.addEventListener('alpine:init', () => Alpine.data('content', () => ({
    /**
     * Support Headings
     *
     * @property {array} headings
     */
    supportHeadings: '.contents_style > h2, .contents_style > h3',

    /**
     * Headings
     *
     * @property {array} headings
     */
    headings: [],

    /**
     * TOC 표시 여부 (본문이 화면에 있을 때만 true)
     */
    tocVisible: false,

    /**
     * Init 'content' Component
     */
    init () {
      this.setAnchorToHeadings()
      this.collectHeading()
      this.highlightCodeBlocks()
      this.addBlankHashToMoreLesses()
      this.setPositionToImages()
      this.observeArticle()
    },

    /**
     * IntersectionObserver로 본문 영역 감지
     */
    observeArticle () {
      const article = this.$refs.article
      if (!article) return
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          this.tocVisible = entry.isIntersecting
        })
      }, {
        threshold: 0,
        rootMargin: '-96px 0px 0px 0px'
      })
      
      observer.observe(article)
    },

    /**
     * Add blank hash To morelesses
     */
    addBlankHashToMoreLesses () {
      this.$article.querySelectorAll('a.btn-toggle-moreless').forEach($moreless => {
        $moreless.setAttribute('href', '#')
      })
    },

    /**
     * Syntax highlighting code blocks in template (Shiki CDN)
     */
    highlightCodeBlocks () {
      this.$article.querySelectorAll('pre code').forEach(codeBlock => {
        if (window.highlightWithShiki) {
          window.highlightWithShiki(codeBlock)
        }
      })
    },

    /**
     * Collect heading in template
     */
    collectHeading () {
      this.$headings.forEach($heading => {
        const heading = this.heading($heading)

        this.headings.push(heading)
      })
    },

    /**
     * Get new Scrollspy item
     *
     * @param {HTMLElement} $heading
     *
     * @return {object}
     */
    heading ($heading) {
      return {
        tagName: $heading.tagName,
        id: $heading.id,
        href: `#${$heading.id}`,
        text: $heading.textContent,
        active: false
      }
    },

    /**
     * Set position to images
     */
    setPositionToImages () {
      this.$article.querySelectorAll('figure.imageblock').forEach(this.setImageBlockPosition.bind(this))
      this.$article.querySelectorAll('figure.imagegridblock').forEach(this.setImageGridBlockPosition.bind(this))
    },

    /**
     * Set image block position
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageBlockPosition ($imageBlock) {
      const width = this.imageBlockWidth($imageBlock)

      if ($imageBlock.classList.contains('alignCenter')) {
        this.setImageBlockToCenter($imageBlock)
      }

      if ($imageBlock.classList.contains('widthContent')) {
        return
      }

      this.setImageBlockWidth($imageBlock, width)
    },

    /**
     * Set image grid block position
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageGridBlockPosition ($imageBlock) {
      const width = this.imageGridBlockWidth()

      this.setImageBlockToCenter($imageBlock)
      this.setImageBlockWidth($imageBlock, width)
    },

    /**
     * Center image block
     *
     * @param {HTMLElement} $imageBlock
     */
    imageBlockWidth ($imageBlock) {
      const $imageWrap = $imageBlock.querySelector('span, a')
      const $image = $imageWrap.querySelector('img')
      const width = $image.getAttribute('width') || $imageBlock.dataset.originWidth

      return width > 1100 ? 1100 : width
    },

    /**
     * Center image grid block
     */
    imageGridBlockWidth () {
      return 1100
    },

    /**
     * set Image Width
     *
     * @param {HTMLElement} $imageBlock
     * @param {String|Number} width
     */
    setImageBlockWidth ($imageBlock, width) {
      $imageBlock.style.width = `${width}px`
      $imageBlock.style.maxWidth = `${width}px`
    },

    /**
     * set Image block to center
     *
     * @param {HTMLElement} $imageBlock
     */
    setImageBlockToCenter ($imageBlock) {
      $imageBlock.style.marginLeft = '50%'
      $imageBlock.style.transform = 'translateX(-50%)'
    },

    /**
     * Set anchor to headings in template
     */
    setAnchorToHeadings () {
      this.$headings.forEach(this.setAnchorToHeading.bind(this))
    },

    /**
     * Set anchor to heading
     *
     * @param {HTMLElement} $heading
     * @param {number} index
     */
    setAnchorToHeading ($heading, index) {
      const link = this.link($heading, index)
      const $anchor = this.$anchor($heading, `#${link}`)

      $heading.setAttribute('id', link)
      $heading.innerHTML = $anchor.outerHTML
    },

    /**
     * Get link for heading
     *
     * @param {HTMLElement} $heading
     * @param {number} index
     *
     * @return {string}
     */
    link ($heading, index) {
      return this.$id(encodeURIComponent($heading.textContent), index)
    },

    /**
     * Get new anchor
     *
     * @param {HTMLElement} $heading
     * @param {string} link
     *
     * @return {HTMLElement}
     */
    $anchor ($heading, link) {
      const $anchor = document.createElement('a')

      $anchor.setAttribute('href', link)
      $anchor.innerHTML = $heading.innerHTML

      return $anchor
    },

    /**
     * Get article template content
     *
     * @return {HTMLElement}
     */
    get $article () {
      return this.$refs.article
    },

    /**
     * Get headings in content
     *
     * @return {NodeListOf<HTMLElement>}
     */
    get $headings () {
      return this.$article.querySelectorAll(this.supportHeadings)
    }
  })))
